#!/bin/sh

# ~/setup_node.sh
# ============================================================

# {{- if and .is_op .is_linux (not .is_macos) (not .is_devcontainer) }}

command_exists() {
    command -v "$@" >/dev/null 2>&1
}

main() {
    printf -- "\n%s=== Setting up 1Password CLI... ===%s\n"

    # Add Docker GPG key
    printf -- "%sAdd 1Password GPG key...%s\n"
    sudo mkdir -m 0755 -p /etc/apt/keyrings
    curl -sS https://downloads.1password.com/linux/keys/1password.asc \
        | sudo gpg --dearmor -o /etc/apt/keyrings/1password-archive-keyring.gpg

    # Setting up 1Password repository
    printf -- "%sSetting up 1Password repository...%s\n"
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" \
        | sudo tee /etc/apt/sources.list.d/1password.list

    # Add debsig-verify policy
    printf -- "%sAdd debsig-verify policy...%s\n"
    sudo mkdir -p /etc/apt/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol \
        | sudo tee /etc/apt/debsig/policies/AC2D62742012EA22/1password.pol
    sudo mkdir -p /etc/apt/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc \
        | sudo gpg --dearmor -o /etc/apt/debsig/keyrings/AC2D62742012EA22/debsig.gpg
    sudo apt update

    # Install 1Password CLI
    printf -- "%sInstalling 1Password CLI...%s\n"
    sudo apt install 1password-cli
    op --version

    # Sign in 1Password CLI
    op account add
}

main "$@"

# {{- end }}
